var unds=_.noConflict();(function(c,i,b){var d={V:86,Z:90,BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35,DELETE:46};var f={onDataRequest:c.noop,realValOnSubmit:true,triggers:{"@":{}},templates:{wrapper:i.template('<div class="textntags-wrapper"></div>'),beautifier:i.template('<div class="textntags-beautifier"><div></div></div>'),tagHighlight:i.template('<strong class="<%= class_name %>"><span>$<%= idx %></span></strong>'),tagList:i.template('<div class="textntags-tag-list"></div>'),tagsListItem:i.template("<li><%= title %></li>"),tagsListItemImage:i.template('<img src="<%= img %>" />'),tagsListItemIcon:i.template('<div class="icon <%= no_img_class %>"></div>')}};var j={minChars:2,uniqueTags:true,showImageOrIcon:true,keys_map:{id:"id",title:"name",description:"",img:"avatar",no_img_class:"icon",type:"type"},syntax:i.template("@[[<%= id %>:<%= type %>:<%= title %>]]"),parser:/(@)\[\[(\d+):([\w\s\.\-]+):([\w\s@\.,-\/#!$%\^&\*;:{}=\-_`~()]+)\]\]/gi,parserGroups:{id:2,type:3,title:4},classes:{tagsDropDown:"",tagActiveDropDown:"active",tagHighlight:""}};function a(k){return function(m,l){var n={};if(l){i.each(k,function(p,o){n[p]=m[o]})}else{i.each(k,function(p,o){n[o]=m[p]})}return n}}var h=i.memoize(a);var g={htmlEncode:function(k){return i.escape(k)},highlightTerm:function(l,k){if(!k&&!k.length){return l}return l.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+k+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")},setCaratPosition:function(m,l){if(m.createTextRange){var k=m.createTextRange();k.move("character",l);k.select()}else{if(m.selectionStart){m.focus();m.setSelectionRange(l,l)}else{m.focus()}}}};var e=function(k){var aa=null,o;var H,J,Y,V,Q;var B;var p,Z;var A=0,L=0,ab=0,I=false;var O=false,s=0,q=0;var n=["[","^","$",".","|","?","*","+","(",")","\\"];function m(ac){if(aa!=null){return false}aa=c.extend(true,{},f,ac);delete aa.triggers[""];i.each(aa.triggers,function(af,ad){aa.triggers[ad]=c.extend(true,{},j,af);if(i.find(n,function(ag){return ag===ad})){var ae="\\"+ad}else{var ae=ad}aa.triggers[ad].finder=new RegExp(ae+"\\w+(\\s+\\w+)?\\s?$","gi")});o=aa.templates;return true}function D(){J=c(k).bind({click:y,keydown:R,keypress:v,keyup:X,input:K,blur:G});H=J.wrapAll(c(o.wrapper())).parent();if(aa.realValOnSubmit){J.closest("form").bind("submit.textntags",function(ac){Y.addClass("preparing form-control").height(J.height());J.hide(0).val(F())})}}function W(){V=c(o.tagList());V.appendTo(H);V.delegate("li","click",N)}function u(){Y=c(o.beautifier());Y.prependTo(H)}function t(){var ad=T(),ac=C(ad);B=ac.tagsCollection;J.val(ac.plain_text);S();if(B.length>0){var ae=i.uniq(i.map(B,function(af){return af[3]}));J.trigger("tagsAdded.textntags",[ae])}}function T(){return J.val()}function M(ac){var ad=ac||F();ad=ad.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");i.each(aa.triggers,function(af){var ae=o.tagHighlight({idx:af.parserGroups.title,class_name:af.classes.tagHighlight});ad=ad.replace(af.parser,ae)});ad=ad.replace(/\n/g,"<br />&shy;");ad=ad.replace(/ {2}/g," &nbsp;")+"&shy;";return ad}function F(){var ae=T(),ac=0,ad,af=aa.triggers;ad=i.map(B,function(ah){var ag=ah[0]-ac,ak=ag>0?ae.substr(ac,ag):"",ai=h(af[ah[2]].keys_map),aj=af[ah[2]].syntax(ai(ah[3],false));ac=ah[0]+ah[1];return ak+aj});return ad.join("")+ae.substr(ac)}function C(ad){if(i.isString(ad)==false){return null}var ac=""+ad,af=[],ae=aa.triggers;i.each(ae,function(ah,ap){var aj=ad.split(ah.parser),ao=0,an=0,ak=aj.length,ag,al,ai,am=i.max(ah.parserGroups);while(ao<ak){if(aj[ao]==ap){ag={};i.each(ah.parserGroups,function(ar,aq){ag[ah.keys_map[aq]]=aj[ao+ar-1];if(aq=="title"){al=aj[ao+ar-1].length}});af.push([an,al,ap,ag]);ai=al;ao+=am}else{ai=aj[ao].length;ao+=1}an+=ai}});af=i.sortBy(af,function(ag){return ag[0]});i.each(ae,function(ag,ah){ac=ac.replace(ag.parser,"$"+ag.parserGroups.title)});return{plain_text:ac,tagged_text:ad,tagsCollection:af}}function S(){Y.find("div").html(M());J.css("height",Y.outerHeight()+"px")}function E(ai){ai=ai||0;var ad=c.browser.webkit?0:-1,ac=J[0].selectionStart+ad,af=J.val().substr(0,ac+ai),ag,ae=null,ah;if(!af||!af.length){return}ag=i.find(aa.triggers,function(aj,al){var ak=af.match(aj.finder);if(ak){ae=al;ah=ak[0].substr(al.length);return true}return false});if(!ae||(ag&&(ah.length<ag.minChars))){r()}else{Z=ah;p=ae;i.defer(i.bind(U,this,Z,ae))}}function y(ac){E(0)}function R(ah){var ag=d,ad=J[0].selectionStart,ae=J[0].selectionEnd,ac=J.val();A=ae-ad;L=ac.length;ab=ah.keyCode;switch(ah.keyCode){case ag.UP:case ag.DOWN:if(!V.is(":visible")){return true}var af=null;if(ah.keyCode==ag.DOWN){if(Q&&Q.length){af=Q.next()}else{af=V.find("li").first()}}else{if(Q&&Q.length){af=Q.prev()}else{af=V.find("li").last()}}w(af,aa.triggers[p].classes.tagActiveDropDown);return false;case ag.RETURN:case ag.TAB:if(Q&&Q.length){I=true;Q.click();return false}return true;case ag.BACKSPACE:case ag.DELETE:if(ah.keyCode==ag.BACKSPACE&&ad==ae&&ad>0){ad-=1}if(ae>ad){z(ad,ae);P(ad,ad-ae)}return true;case ag.LEFT:case ag.RIGHT:case ag.HOME:case ag.END:i.defer(function(){E.call(this,0)});break;case ag.V:if(ah.ctrlKey){O=true;s=ad;q=ae-ad;z(ad,ae)}break;case ag.Z:if(ah.ctrlKey){return false}break}return true}function v(ac){if(ac.keyCode==d.RETURN){S(J.val())}if(I){if(ac.keyCode==d.RETURN||ac.keyCode==d.TAB){ac.preventDefault()}I=false}}function X(ae){if(O){O=false;if(A>0){return}var ac=J[0].selectionStart,ad=J[0].selectionEnd;P(s,ad-s-q);S()}}function K(ag){var ad=c.browser.webkit?0:-1;if(ab!=d.BACKSPACE&&ab!=d.DELETE){if(A>0){var ac=J[0].selectionStart+ad,ah=A,af=ac+ah,ae=J.val().length-L;z(ac,af);P(af,ae)}else{if(!O){var ac=J[0].selectionStart+ad,af=J[0].selectionEnd+ad,ah=af-ac;if(ab==d.RETURN){P(ac-1,1);z(ac,ac)}else{P(ac,1);z(ac,ac+1)}}}}S();E(1)}function G(ac){i.delay(r,100)}function r(){Q=null;V.hide().empty()}function N(ac){x(c(this).data("tag"));return false}function z(ae,ac){var ad=[];B=i.filter(B,function(af){var ag=af[0],ah=ag+af[1],ai=((ag>=ae&&ag<ac)||(ah>ae&&ah<=ac)||(ag<ae&&ah>ac));if(ai){ad.push(af[3])}return !ai});if(ad.length>0){J.trigger("tagsRemoved.textntags",[ad])}}function P(ac,ad){B=i.map(B,function(ae){if(ae[0]>=ac){ae[0]+=ad}return ae})}function x(am){var ag=aa.triggers[p],ad=h(ag.keys_map),aj=ad(am,false),ak=T(),af=J[0].selectionStart,ah=af-p.length-Z.length,al=ah+aj.title.length,ac=ak.substr(0,ah),ai=ak.substr(af),ae=ac+aj.title+ai;P(af,al-af);am[ag.keys_map.id]=""+am[ag.keys_map.id];B.push([ah,aj.title.length,p,am]);B=i.sortBy(B,function(an){return an[0]});p="";Z="";r();J.val(ae);S();J.focus();g.setCaratPosition(J[0],al);J.trigger("tagsAdded.textntags",[[am]])}function w(ad,ac){if(ad&&ad.length){ad.addClass(ac);ad.siblings().removeClass(ac);Q=ad}else{Q.removeClass(ac);Q=null}}function l(ai,ak,af){var ad=aa.triggers[ak];if(ad.uniqueTags){var ah=ad.keys_map.id,ae=i.map(B,function(al){return al[3][ah]});af=i.reject(af,function(al){return i.include(ae,""+al[ah])})}if(!af.length){return}var ag=c("<ul />").addClass(ad.classes.tagsDropDown).appendTo(V),aj=ad.showImageOrIcon?o.tagsListItemImage:o.tagsListItemIcon,ac=h(ad.keys_map);i.each(af,function(am,an){var ao,al=ac(am,false);al.title=g.highlightTerm(g.htmlEncode((al.title)),ai);ao=c(o.tagsListItem(al)).data("tag",am);if(al.img){ao=ao.prepend(aj(al))}ao.appendTo(ag);if(an===0){w(ao,ad.classes.tagActiveDropDown)}});V.show()}function U(ad,ac){r();aa.onDataRequest.call(this,"search",ad,ac,function(ae){l(ad,ac,ae)})}return{init:function(ac){if(m(ac)){D();W();u();t()}},val:function(ae){if(i.isString(ae)){var ac=i.uniq(i.map(B,function(af){return af[3]}));J.trigger("tagsRemoved.textntags",[ac]);J.val(ae);t();return}else{if(!i.isFunction(ae)){return}}var ad=B.length?F():T();ae.call(this,ad)},reset:function(){var ac=i.uniq(i.map(B,function(ad){return ad[3]}));J.trigger("tagsRemoved.textntags",[ac]);J.val("");B=[];S()},getTags:function(ad){if(!i.isFunction(ad)){return}var ac=i.map(B,function(ae){return ae[3]});ad.call(this,i.uniq(ac))},getTagsMap:function(ac){if(!i.isFunction(ac)){return}ac.call(this,B)},getTagsMapFacebook:function(ae){if(!i.isFunction(ae)){return}var ad={},ac=aa.triggers;i.each(B,function(ag){var ah=h(ac[ag[2]].keys_map),af=ah(ag[3],false);ad[ag[0]]=[{id:af.id,name:af.title,type:af.type,offset:ag[0],length:ag[1]}]});ae.call(this,ad)},parseTaggedText:function(ac,ad){if(!i.isFunction(ad)){return}ad.call(this,C(ac))}}};c.fn.textntags=function(k){var l=arguments;return this.each(function(){var n=k,m=c.data(this,"textntags")||c.data(this,"textntags",new e(this));if(i.isFunction(m[n])){return m[n].apply(this,Array.prototype.slice.call(l,1))}else{if(typeof n==="object"||!n){return m.init.call(this,n)}else{c.error("Method "+n+" does not exist")}}})}})(jQuery,unds);